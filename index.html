<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PMP + Agile Hangman — Project Health</title>
  <meta name="description" content="A hangman-style learning game using PMP + Agile vocabulary. Practice mode, Exam mode, no-repeat deck per device, and shareable results." />
  <style>
    :root{
      --bgA:#f7f7fb;
      --bgB:#eef9f4;
      --bgC:#fff7ed;

      --card:rgba(255,255,255,0.78);
      --cardSolid:#ffffff;

      --text:#0f172a;
      --muted:#475569;

      --border:rgba(15,23,42,0.10);
      --shadow: 0 18px 50px rgba(15,23,42,0.12);

      --accent:#0f766e;     /* teal */
      --accent2:#b45309;    /* warm amber */
      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;

      --radius:24px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 15%, var(--bgC), transparent 60%),
        radial-gradient(900px 600px at 85% 10%, #e8f2ff, transparent 55%),
        radial-gradient(900px 600px at 60% 90%, #e8fbf0, transparent 60%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
      padding:18px;
    }

    a{color:inherit}
    .container{max-width:1100px;margin:0 auto}

    /* Top bar */
    .topbar{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      margin-bottom:16px;
    }
    .brand h1{
      margin:0;
      font-size: clamp(26px, 3vw, 40px);
      letter-spacing:-0.02em;
      line-height:1.12;
      font-weight:800;
    }
    .brand h1 .accent{
      color:var(--accent);
      font-weight:900;
    }
    .brand p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .pill{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      white-space:nowrap;
      font-size:14px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);display:inline-block}
    .pill b{font-variant-numeric: tabular-nums}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .cardInner{padding:18px}

    /* Intro / Help */
    .hero{
      padding:22px;
      display:grid;
      gap:14px;
    }
    .hero h2{
      margin:0;
      font-size:22px;
      letter-spacing:-0.01em;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      line-height:1.6;
      font-size:15px;
    }
    .hero .ctaRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .helpList{
      margin:0;
      padding-left:18px;
      color:var(--muted);
      line-height:1.7;
      font-size:14px;
    }
    .helpList li{margin:6px 0}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .topbar{flex-direction:column;align-items:stretch}
      .pill{justify-content:space-between}
      .grid{grid-template-columns:1fr}
    }

    /* Sections */
    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;
      margin:0 0 12px;
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
    }
    .sectionTitle h3{
      margin:0;
      font-size:15px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#1f2937;
    }
    .sectionTitle .meta{
      font-size:13px;
      color:var(--muted);
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    /* Controls row */
    .controls{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center;
      margin: 10px 0 14px;
    }
    label.small{font-size:12px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted)}
    select, button, .toggle{
      font-family:inherit;
    }
    select{
      background: rgba(255,255,255,0.9);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      min-width:160px;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.75);
      color:var(--text);
      border-radius:16px;
      padding:10px 14px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(15,23,42,0.06);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px)}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(15,118,110,0.95), rgba(15,118,110,0.82));
      border-color: rgba(15,118,110,0.35);
      color:white;
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(180,83,9,0.92), rgba(180,83,9,0.80));
      border-color: rgba(180,83,9,0.35);
      color:white;
    }
    .btnGhost{
      background: rgba(255,255,255,0.5);
    }

    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:8px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.65);
    }
    .switch{
      width:46px;height:26px;border-radius:999px;
      background: rgba(15,23,42,0.12);
      border:1px solid rgba(15,23,42,0.10);
      position:relative;
      flex:0 0 auto;
    }
    .knob{
      width:22px;height:22px;border-radius:999px;
      background:white;
      position:absolute;top:1px;left:1px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.12);
      transition: transform 160ms ease;
    }
    .switch.on{
      background: rgba(15,118,110,0.25);
      border-color: rgba(15,118,110,0.35);
    }
    .switch.on .knob{transform: translateX(20px)}
    .toggleText{font-size:14px;font-weight:800}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.65);
      font-weight:800;
      font-variant-numeric: tabular-nums;
    }
    .chip small{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:0.12em;text-transform:uppercase}

    /* Word display */
    .wordBoxes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      min-height:112px;
      align-content:flex-start;
    }
    .box{
      width:54px;height:54px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.55);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:900;
      box-shadow: 0 12px 30px rgba(15,23,42,0.06);
      user-select:none;
    }
    .box.filled{
      background: rgba(15,118,110,0.12);
      border-color: rgba(15,118,110,0.22);
    }
    .box.auto{
      background: rgba(148,163,184,0.22);
      border-color: rgba(148,163,184,0.22);
      color:#0f172a;
      font-weight:900;
    }

    .rowBetween{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-top:10px;color:var(--muted);font-size:14px
    }

    /* Keyboard */
    .kbd{
      margin-top:12px;
    }
    .kbdTitle{
      display:flex;align-items:center;justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      margin:14px 0 8px;
      font-weight:900;
    }
    .keys{
      display:flex;flex-wrap:wrap;gap:10px;
    }
    .key{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.75);
      box-shadow: 0 12px 26px rgba(15,23,42,0.06);
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .key:hover{transform: translateY(-1px)}
    .key:active{transform: translateY(0px)}
    .key.used{
      opacity:0.38;
      cursor:not-allowed;
      transform:none;
    }
    .key.good{
      background: rgba(22,163,74,0.18);
      border-color: rgba(22,163,74,0.22);
    }
    .key.bad{
      background: rgba(220,38,38,0.15);
      border-color: rgba(220,38,38,0.20);
    }

    /* Right panel cards */
    .stack{display:grid;gap:14px}
    .meterWrap{
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .meter{
      height:14px;
      border-radius:999px;
      background: rgba(15,23,42,0.10);
      border:1px solid rgba(15,23,42,0.08);
      overflow:hidden;
      flex:1;
    }
    .meterFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(22,163,74,0.95), rgba(15,118,110,0.75));
      border-radius:999px;
      transition: width 200ms ease;
    }
    .meterLabel{
      font-weight:900;
      font-variant-numeric: tabular-nums;
      min-width:92px;
      text-align:right;
    }
    .tileRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width: 520px){
      .tileRow{grid-template-columns:1fr}
      .box{width:48px;height:48px;border-radius:14px}
      .key{width:44px;height:44px;border-radius:14px}
    }

    .tile{
      padding:16px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(255,255,255,0.65);
      box-shadow: 0 12px 30px rgba(15,23,42,0.06);
    }
    .tile h4{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .tile .big{
      font-size:30px;
      font-weight:900;
      font-variant-numeric: tabular-nums;
      margin:0;
    }
    .tile p{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.55;
      font-size:14px;
    }

    /* Hint / Definition */
    .callout{
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px dashed rgba(15,23,42,0.18);
      background: rgba(255,255,255,0.55);
      color: #0f172a;
      line-height:1.55;
      font-size:14px;
    }
    .callout .label{
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
      margin-bottom:6px;
    }

    /* Small helper */
    .miniTip{
      margin-top:12px;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
      opacity:0.9;
      text-align:center;
    }

    /* Footer link row inside views */
    .subActions{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-top:14px;
      color:var(--muted);
      font-size:13px;
    }
    .linkBtn{
      border:none;
      background:none;
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
      padding:0;
      text-decoration:underline;
    }
  </style>
</head>
<body>
  <div class="container">

    <header class="topbar">
      <div class="brand">
        <h1>PMP + Agile Hangman — <span class="accent">Project Health</span></h1>
        <p>Practice mode or Exam mode • 1000-term bank • No repeats per device until exhausted</p>
      </div>
      <div class="pill" aria-label="streaks">
        <span class="dot" aria-hidden="true"></span>
        <span>Best Streak: <b id="bestStreak">0</b></span>
        <span>Current Streak: <b id="currentStreak">0</b></span>
      </div>
    </header>

    <main>

      <!-- INTRO VIEW -->
      <section id="viewIntro" class="view active">
        <div class="card">
          <div class="hero">
            <h2>What this is</h2>
            <p>
              A hangman-style game for project managers: guess a PMBOK/PMP term letter-by-letter,
              use a meaning-based hint when you’re stuck, and build a streak.
            </p>
            <p>
              <b>Practice</b> is open-ended. <b>Exam mode</b> runs a 10-round session and gives a share-ready summary.
              Your no-repeat “deck” is stored on <b>your device only</b> (so other people won’t affect your remaining count).
            </p>

            <div class="ctaRow">
              <button class="btn btnPrimary" id="btnIntroStart">Start</button>
              <button class="btn btnGhost" id="btnIntroHow">Instructions</button>
            </div>

            <div class="subActions">
              <span>Tip: If you’re testing, use an Incognito window to simulate a “new user”.</span>
              <button class="linkBtn" id="btnJumpToGame">Skip intro</button>
            </div>
          </div>
        </div>
      </section>

      <!-- HELP VIEW -->
      <section id="viewHelp" class="view">
        <div class="card">
          <div class="hero">
            <h2>How to play</h2>
                        <ul class="helpList">
              <li><b>First step (recommended)</b>: Click <b>Reset Deck</b> to start from the full 1000-term bank on this device.</li>
              <li><b>Difficulty</b>: Easy gives more help, Hard is stricter. (You can change anytime.)</li>
              <li><b>Practice / Exam</b>: Toggle Exam ON for a 10-round session summary.</li>
              <li><b>Reset Deck</b>: Clears your device’s history so terms won’t “run out”.</li>
              <li><b>New word</b>: Skips to a fresh term (counts as a new round).</li>
              <li><b>Show hint</b>: Shows a meaning-based clue (masked so it won’t reveal the answer). Once per round.</li>
              <li><b>Keyboard</b>: Click letters or type on your physical keyboard.</li>
              <li><b>Health meter</b>: Each wrong guess reduces health. Solve the term before it hits zero.</li>
              <li><b>Share</b>: Copies a share message (and uses native share on mobile if available).</li>
            </ul>

            <div class="ctaRow">
              <button class="btn btnPrimary" id="btnHelpStart">Start game</button>
              <button class="btn btnGhost" id="btnHelpBack">Back</button>
            </div>
          </div>
        </div>
      </section>

      <!-- GAME VIEW -->
      <section id="viewGame" class="view">
        <div class="grid">
          <!-- LEFT: guess + keyboard -->
          <div class="card">
            <div class="cardInner">
              <div class="sectionTitle">
                <h3>Guess the term</h3>
                <div class="meta" id="bankMeta">Bank: —</div>
              </div>

              <div class="controls">
                <div>
                  <label class="small" for="selDifficulty">Difficulty</label><br/>
                  <select id="selDifficulty" aria-label="difficulty">
                    <option value="easy">Easy</option>
                    <option value="balanced" selected>Balanced</option>
                    <option value="hard">Hard</option>
                  </select>
                </div>

                <div class="toggle" role="group" aria-label="mode toggle">
                  <div id="switchExam" class="switch" tabindex="0" aria-label="exam mode toggle" aria-checked="false" role="switch">
                    <div class="knob"></div>
                  </div>
                  <div>
                    <div class="toggleText" id="modeLabel">Practice</div>
                    <div style="font-size:12px;color:var(--muted);font-weight:700">Exam mode = 10 rounds</div>
                  </div>
                </div>

                <div class="chip" aria-label="remaining">
                  <small>Remaining</small>
                  <span id="remainingCount">—</span>
                </div>

                <button class="btn btnGhost" id="btnShare">Share</button>
                <button class="btn btnWarn" id="btnResetDeck">Reset Deck</button>
              </div>

              <div class="wordBoxes" id="wordBoxes" aria-label="word boxes"></div>

              <div class="rowBetween">
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn btnGhost" id="btnHint">Show hint</button>
                  <button class="btn btnPrimary" id="btnNew">New word</button>
                </div>
                <div>Wrong guesses left: <b id="livesLeft">—</b></div>
              </div>

              <div class="callout" id="hintWrap" style="display:none">
                <div class="label">Hint</div>
                <div id="hintText">—</div>
              </div>

              <div class="kbd">
                <div class="kbdTitle">
                  <span>Keyboard</span>
                  <span>Tip: you can type on your keyboard too</span>
                </div>
                <div class="keys" id="keys"></div>
              </div>

              <div class="miniTip" id="statusLine">Ready.</div>
            </div>
          </div>

          <!-- RIGHT: project health -->
          <div class="card">
            <div class="cardInner">
              <div class="sectionTitle">
                <h3>Project Health</h3>
                <div class="meta" id="modeMeta">Practice • Balanced</div>
              </div>

              <div class="tile">
                <div class="meterWrap">
                  <div style="display:flex;flex-direction:column;gap:6px;flex:1">
                    <h4 style="margin:0;font-size:12px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted)">Health meter</h4>
                    <div class="meter" aria-label="health meter"><div class="meterFill" id="meterFill"></div></div>
                  </div>
                  <div class="meterLabel" id="healthLabel">On Track</div>
                </div>
                <p>Wrong guesses reduce health. Solve the term to keep the project green.</p>
              </div>

              <div class="tileRow" style="margin-top:14px">
                <div class="tile">
                  <h4>Score</h4>
                  <p class="big" id="score">0</p>
                </div>
                <div class="tile">
                  <h4>Solved</h4>
                  <p class="big" id="solved">0</p>
                </div>
              </div>

              <div class="tile" style="margin-top:14px">
                <h4>Definition</h4>
                <p id="defText">Solve the term (or run out of guesses) to see the definition.</p>
              </div>

              <div class="tile" style="margin-top:14px">
                <h4>Exam mode</h4>
                <p>Turn Exam ON to run a 10-round session. At the end you’ll get a summary and a share-ready message.</p>
              </div>

              <div class="subActions">
                <button class="linkBtn" id="btnBackHome">Back to intro</button>
                <span>Works on Chrome, Safari, and mobile.</span>
              </div>

            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    /**********************
     * Small utilities
     **********************/
    const $ = (id) => document.getElementById(id);

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    function titleCase(s){
      return s.toLowerCase().replace(/\b[a-z]/g, (m)=>m.toUpperCase());
    }

    /**********************
     * Views
     **********************/
    const viewIntro = $("viewIntro");
    const viewHelp  = $("viewHelp");
    const viewGame  = $("viewGame");

    function showView(which){
      for(const v of [viewIntro, viewHelp, viewGame]) v.classList.remove("active");
      if(which === "intro") viewIntro.classList.add("active");
      if(which === "help")  viewHelp.classList.add("active");
      if(which === "game")  viewGame.classList.add("active");
    }

    $("btnIntroStart").addEventListener("click", () => { showView("game"); bootIfNeeded(); });
    $("btnIntroHow").addEventListener("click", () => showView("help"));
    $("btnHelpBack").addEventListener("click", () => showView("intro"));
    $("btnHelpStart").addEventListener("click", () => { showView("game"); bootIfNeeded(); });
    $("btnJumpToGame").addEventListener("click", () => { showView("game"); bootIfNeeded(); });
    $("btnBackHome").addEventListener("click", () => showView("intro"));

    /**********************
     * Word bank loading
     **********************/
    let BANK = [];
    let bankReady = false;

    async function loadBank(){
      if(bankReady) return;
      $("statusLine").textContent = "Loading word bank…";
      try{
        const res = await fetch("words.json", {cache:"no-store"});
        if(!res.ok) throw new Error("Could not load words.json ("+res.status+")");
        BANK = await res.json();
        if(!Array.isArray(BANK) || BANK.length < 50) throw new Error("words.json does not look valid.");
        bankReady = true;
        $("statusLine").textContent = "Word bank loaded.";
      }catch(err){
        console.error(err);
        $("statusLine").textContent = "Could not load words.json. Make sure it is in the same folder as index.html.";
      }
    }

    /**********************
     * No-repeat deck (per device)
     **********************/
    const STORAGE_KEY = "pmpHangman.deck.v3";
    const STREAK_KEY  = "pmpHangman.streak.v3";

    function bankSignature(){
      // simple signature: length + first term + last term
      const first = (BANK[0]?.term || "").slice(0,24);
      const last  = (BANK[BANK.length-1]?.term || "").slice(0,24);
      return `len:${BANK.length}|f:${first}|l:${last}`;
    }

    function defaultDeck(){
      return { signature: bankSignature(), used: {} };
    }

    function loadDeck(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultDeck();
        const obj = JSON.parse(raw);
        if(!obj || obj.signature !== bankSignature()) return defaultDeck();
        if(!obj.used) obj.used = {};
        return obj;
      }catch{
        return defaultDeck();
      }
    }

    function saveDeck(deck){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(deck)); }catch{}
    }

    function resetDeck(){
      const d = defaultDeck();
      saveDeck(d);
      updateRemaining(d);
      $("statusLine").textContent = "Deck reset on this device.";
    }

    function updateRemaining(deck){
      const remaining = BANK.length - Object.keys(deck.used||{}).length;
      $("remainingCount").textContent = remaining.toString();
      $("bankMeta").textContent = `Bank: ${BANK.length} terms`;
    }

    function pickNext(deck){
      // pick a term that hasn't been used on this device. If exhausted, reset used.
      const used = deck.used || {};
      if(Object.keys(used).length >= BANK.length){
        deck.used = {};
      }
      // Simple random pick with retry
      for(let i=0;i<5000;i++){
        const idx = Math.floor(Math.random()*BANK.length);
        if(!deck.used[idx]){
          deck.used[idx] = 1;
          saveDeck(deck);
          updateRemaining(deck);
          return BANK[idx];
        }
      }
      // fallback
      const idx = Math.floor(Math.random()*BANK.length);
      deck.used[idx]=1;
      saveDeck(deck);
      updateRemaining(deck);
      return BANK[idx];
    }

    /**********************
     * Hint masking
     **********************/
    function safeHint(term, definition){
      if(!definition) return "No hint available for this term yet.";
      let hint = String(definition);

      // Remove exact term (case-insensitive)
      const esc = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      hint = hint.replace(new RegExp(esc, "ig"), "____");

      // Remove significant term words (>=4 chars) so hint doesn't literally contain the answer
      const words = term
        .toUpperCase()
        .replace(/[^A-Z0-9 ]+/g, " ")
        .split(/\s+/)
        .filter(Boolean)
        .filter(w => w.length >= 4);

      for(const w of words){
        const re = new RegExp("\\b"+w+"\\b", "ig");
        hint = hint.replace(re, "____");
      }

      // Clean up repeated blanks
      hint = hint.replace(/(__+\s*){2,}/g, "____ ");
      hint = hint.replace(/\s+/g, " ").trim();

      // Make sure it's not empty
      if(hint.length < 8){
        return "A common PMP/Agile concept related to project delivery. (Hint was masked to avoid giving the answer.)";
      }
      return hint;
    }

    /**********************
     * Game state
     **********************/
    let deck = null;
    let currentPick = null;
    let normalizedAnswer = "";
    let revealed = [];
    let guessed = {};
    let livesMax = 6;
    let livesLeft = 6;
    let solvedCount = 0;
    let score = 0;

    // Exam mode: 10 rounds
    let examOn = false;
    let examRound = 0;
    let examSolved = 0;
    let examScore = 0;

    // Hint usage
    let hintUsed = false;

    // Streaks
    function loadStreak(){
      try{
        const raw = localStorage.getItem(STREAK_KEY);
        if(!raw) return {best:0, current:0};
        const s = JSON.parse(raw);
        return {best: s.best||0, current: s.current||0};
      }catch{
        return {best:0, current:0};
      }
    }
    function saveStreak(s){
      try{ localStorage.setItem(STREAK_KEY, JSON.stringify(s)); }catch{}
    }
    function updateStreakUI(s){
      $("bestStreak").textContent = String(s.best||0);
      $("currentStreak").textContent = String(s.current||0);
    }
    let streak = loadStreak();
    updateStreakUI(streak);

    /**********************
     * Difficulty settings
     **********************/
    function applyDifficulty(diff){
      if(diff === "easy"){
        livesMax = 8;
      }else if(diff === "hard"){
        livesMax = 5;
      }else{
        livesMax = 6;
      }
      livesLeft = Math.min(livesLeft, livesMax);
      renderHealth();
      $("modeMeta").textContent = `${examOn ? "Exam" : "Practice"} • ${titleCase(diff)}`;
    }

    /**********************
     * Rendering
     **********************/
    function renderBoxes(){
      const boxWrap = $("wordBoxes");
      boxWrap.innerHTML = "";
      const answer = currentPick.term;
      for(let i=0;i<answer.length;i++){
        const ch = answer[i];
        const box = document.createElement("div");
        box.className = "box";
        if(ch === " " || ch === "-" || ch === "/"){
          box.classList.add("auto");
          box.textContent = ch;
        }else{
          const show = revealed[i] ? ch.toUpperCase() : "";
          box.textContent = show;
          if(show) box.classList.add("filled");
        }
        boxWrap.appendChild(box);
      }
    }

    function renderKeyboard(){
      const keys = $("keys");
      keys.innerHTML = "";
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      for(const L of letters){
        const btn = document.createElement("button");
        btn.className = "key";
        btn.textContent = L;
        btn.type = "button";
        if(guessed[L]){
          btn.classList.add("used");
          if(guessed[L] === "good") btn.classList.add("good");
          if(guessed[L] === "bad") btn.classList.add("bad");
        }
        btn.addEventListener("click", () => handleGuess(L));
        keys.appendChild(btn);
      }
    }

    function renderHealth(){
      $("livesLeft").textContent = String(livesLeft);
      const pct = clamp(livesLeft / livesMax, 0, 1);
      $("meterFill").style.width = (pct*100).toFixed(0) + "%";

      // label
      let label = "On Track";
      if(pct <= 0.34) label = "At Risk";
      else if(pct <= 0.67) label = "Watch";
      $("healthLabel").textContent = label;

      // subtle color shift (no hard coding extra colors)
      if(pct <= 0.34) $("meterFill").style.filter = "saturate(1.1) contrast(1.05)";
      else $("meterFill").style.filter = "none";
    }

    function setHintVisible(visible){
      $("hintWrap").style.display = visible ? "block" : "none";
    }

    function setDefinitionText(txt){
      $("defText").textContent = txt;
    }

    function updateScoreUI(){
      $("score").textContent = String(score);
      $("solved").textContent = String(solvedCount);
    }

    /**********************
     * Round lifecycle
     **********************/
    function normalizeAnswer(str){
      return str.toUpperCase();
    }

    function startRound(){
      setHintVisible(false);
      hintUsed = false;
      setDefinitionText("Solve the term (or run out of guesses) to see the definition.");

      currentPick = pickNext(deck);
      normalizedAnswer = normalizeAnswer(currentPick.term);
      revealed = [];
      guessed = {};
      livesLeft = livesMax;

      for(let i=0;i<normalizedAnswer.length;i++){
        const ch = normalizedAnswer[i];
        if(ch === " " || ch === "-" || ch === "/"){
          revealed[i] = true;
        }else{
          revealed[i] = false;
        }
      }

      $("statusLine").textContent = examOn
        ? `Exam: Round ${examRound+1}/10`
        : "Practice: New term loaded.";

      renderBoxes();
      renderKeyboard();
      renderHealth();
      updateScoreUI();
    }

    function allRevealed(){
      for(let i=0;i<normalizedAnswer.length;i++){
        const ch = normalizedAnswer[i];
        if(ch === " " || ch === "-" || ch === "/") continue;
        if(!revealed[i]) return false;
      }
      return true;
    }

    function endRound(win){
      // show definition now
      const def = currentPick.definition || currentPick.hint || "No definition available for this term yet.";
      setDefinitionText(def);

      if(win){
        solvedCount += 1;
        score += 10 + livesLeft; // reward for remaining health
        $("statusLine").textContent = "Solved! +score. Click New word to continue.";

        streak.current += 1;
        streak.best = Math.max(streak.best, streak.current);
        saveStreak(streak);
        updateStreakUI(streak);

        if(examOn){
          examSolved += 1;
          examScore += 10 + livesLeft;
        }
      }else{
        $("statusLine").textContent = "Out of guesses. Click New word to continue.";
        streak.current = 0;
        saveStreak(streak);
        updateStreakUI(streak);

        if(examOn){
          // no score
        }
      }

      updateScoreUI();

      // Exam progression
      if(examOn){
        examRound += 1;
        if(examRound >= 10){
          // End exam
          const msg = `PMP Hangman — Exam Results: ${examSolved}/10 solved • Score ${examScore}.`;
          $("statusLine").textContent = "Exam finished! Use Share to copy your results.";
          // store summary for share
          window.__examSummary = msg;
          // auto-turn exam off for next play
          toggleExam(false, true);
        }
      }
    }

    function handleGuess(letter){
      if(!currentPick) return;
      const L = letter.toUpperCase();
      if(guessed[L]) return; // already guessed

      let hit = false;
      for(let i=0;i<normalizedAnswer.length;i++){
        if(normalizedAnswer[i] === L){
          revealed[i] = true;
          hit = true;
        }
      }

      guessed[L] = hit ? "good" : "bad";
      if(!hit){
        livesLeft -= 1;
      }

      renderBoxes();
      renderKeyboard();
      renderHealth();

      if(allRevealed()){
        endRound(true);
        return;
      }

      if(livesLeft <= 0){
        // reveal everything
        for(let i=0;i<revealed.length;i++){
          if(normalizedAnswer[i] !== " " && normalizedAnswer[i] !== "-" && normalizedAnswer[i] !== "/"){
            revealed[i] = true;
          }
        }
        renderBoxes();
        endRound(false);
      }
    }

    /**********************
     * Share
     **********************/
    async function share(){
      const url = location.href.split("#")[0];
      const diff = $("selDifficulty").value;
      const mode = examOn ? "Exam" : "Practice";
      const base = window.__examSummary
        ? window.__examSummary
        : `PMP + Agile Hangman — ${mode} • ${titleCase(diff)} • Solved ${solvedCount} • Score ${score}`;
      const text = `${base}\n${url}`;

      try{
        if(navigator.share){
          await navigator.share({title:"PMP Hangman", text, url});
          $("statusLine").textContent = "Shared.";
          return;
        }
      }catch(e){
        // ignore and fall back
      }

      try{
        await navigator.clipboard.writeText(text);
        $("statusLine").textContent = "Copied share text to clipboard.";
      }catch{
        // last fallback
        prompt("Copy this:", text);
      }
    }

    /**********************
     * Exam toggle
     **********************/
    function toggleExam(on, silent){
      examOn = !!on;
      $("switchExam").classList.toggle("on", examOn);
      $("switchExam").setAttribute("aria-checked", examOn ? "true" : "false");
      $("modeLabel").textContent = examOn ? "Exam" : "Practice";
      $("modeMeta").textContent = `${examOn ? "Exam" : "Practice"} • ${titleCase($("selDifficulty").value)}`;

      if(examOn){
        examRound = 0;
        examSolved = 0;
        examScore = 0;
        window.__examSummary = null;
        if(!silent) $("statusLine").textContent = "Exam mode ON (10 rounds).";
      }else{
        if(!silent) $("statusLine").textContent = "Practice mode ON.";
      }
    }

    $("switchExam").addEventListener("click", () => { toggleExam(!examOn); startRound(); });
    $("switchExam").addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleExam(!examOn);
        startRound();
      }
    });

    /**********************
     * Buttons / Inputs
     **********************/
    $("btnShare").addEventListener("click", share);
    $("btnResetDeck").addEventListener("click", () => {
      resetDeck();
      startRound();
    });
    $("btnNew").addEventListener("click", () => startRound());
    $("btnHint").addEventListener("click", () => {
      if(!currentPick) return;
      if(hintUsed){
        $("statusLine").textContent = "Hint already used this round.";
        return;
      }
      const def = currentPick.definition || currentPick.hint || "";
      const pre = currentPick.hint ? String(currentPick.hint) : "";
      $("hintText").textContent = pre || safeHint(currentPick.term, def);
      setHintVisible(true);
      hintUsed = true;
      $("statusLine").textContent = "Hint shown (masked).";
    });

    $("selDifficulty").addEventListener("change", () => {
      applyDifficulty($("selDifficulty").value);
      // reset lives to new max for the current round
      livesLeft = livesMax;
      renderHealth();
      $("statusLine").textContent = `Difficulty set to ${titleCase($("selDifficulty").value)}.`;
    });

    // physical keyboard support
    window.addEventListener("keydown", (e) => {
      if(!viewGame.classList.contains("active")) return;
      const k = e.key.toUpperCase();
      if(k.length === 1 && k >= "A" && k <= "Z"){
        handleGuess(k);
      }
    });

    /**********************
     * Boot
     **********************/
    let booted = false;
    async function bootIfNeeded(){
      if(booted) return;
      booted = true;
      await loadBank();
      if(!bankReady) return;
      deck = loadDeck();
      updateRemaining(deck);
      applyDifficulty($("selDifficulty").value);
      toggleExam(false, true);
      startRound();
    }

    // Preload bank immediately (so Start feels instant)
    loadBank();
  </script>
</body>
</html>
